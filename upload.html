<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上传照片 - 光影分享</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- 导航栏（与首页相同） -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <i class="fas fa-camera"></i>
                <span>光影分享</span>
            </a>
            
            <div class="nav-links">
                <a href="index.html"><i class="fas fa-home"></i> 首页</a>
                <a href="upload.html" class="active"><i class="fas fa-cloud-upload-alt"></i> 上传</a>
                <a href="discussion.html"><i class="fas fa-comments"></i> 讨论区</a>
                <a href="profile.html"><i class="fas fa-user"></i> 个人主页</a>
            </div>
            
            <button class="menu-toggle" onclick="toggleMenu()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- 移动端菜单 -->
    <div class="mobile-menu" id="mobileMenu">
        <a href="index.html"><i class="fas fa-home"></i> 首页</a>
        <a href="upload.html" class="active"><i class="fas fa-cloud-upload-alt"></i> 上传</a>
        <a href="discussion.html"><i class="fas fa-comments"></i> 讨论区</a>
        <a href="profile.html"><i class="fas fa-user"></i> 个人主页</a>
    </div>

    <main class="container">
        <div class="form-container">
            <div class="form-title">
                <h2><i class="fas fa-cloud-upload-alt"></i> 上传照片</h2>
                <p>分享你的美好瞬间，支持最多20张，总大小不超过35MB</p>
            </div>

            <!-- 上传区域 -->
            <div class="upload-area" id="uploadArea" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
                <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" 
                       onchange="handleFileSelect(event)">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>点击或拖拽上传照片</h3>
                <p>支持 JPG, PNG, GIF 格式，最多20张</p>
                <p class="file-size-info">总大小限制：35MB</p>
                <button class="btn-primary" onclick="document.getElementById('fileInput').click()">
                    选择文件
                </button>
            </div>

            <!-- 预览区域 -->
            <div class="preview-container" id="previewContainer">
                <!-- 预览图片会显示在这里 -->
            </div>

            <!-- 表单 -->
            <div class="form-group">
                <label for="description"><i class="fas fa-pen"></i> 描述（可选）</label>
                <textarea id="description" rows="3" placeholder="为你的照片添加描述..."></textarea>
            </div>

            <div class="form-group">
                <label for="keywords"><i class="fas fa-tags"></i> 关键词</label>
                <input type="text" id="keywords" placeholder="添加关键词，用逗号分隔，至少一个（如：风景,自然,旅行）">
                <small>关键词可以帮助其他人发现你的照片</small>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="isPrivate">
                    <i class="fas fa-lock"></i> 设为私密（仅自己可见）
                </label>
            </div>

            <!-- 上传进度 -->
            <div class="upload-progress" id="uploadProgress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressText">正在上传...</p>
            </div>

            <!-- 消息提示 -->
            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>

            <!-- 操作按钮 -->
            <div class="form-actions">
                <button class="btn-primary" onclick="uploadPhotos()" id="uploadBtn">
                    <i class="fas fa-upload"></i> 上传照片
                </button>
                <button class="btn-secondary" onclick="clearAll()">
                    <i class="fas fa-trash"></i> 清空所有
                </button>
            </div>

            <!-- 上传规则 -->
            <div class="upload-rules">
                <h4><i class="fas fa-info-circle"></i> 上传规则：</h4>
                <ul>
                    <li>每张照片最大10MB</li>
                    <li>一次最多上传20张照片</li>
                    <li>总大小不超过35MB</li>
                    <li>支持格式：JPG, PNG, GIF</li>
                    <li>请勿上传侵权或违规内容</li>
                </ul>
            </div>
        </div>
    </main>

    <footer>
        <p>© 2024 光影分享 - 分享你的美好瞬间</p>
    </footer>

    <script>
        // 配置信息
        const SUPABASE_URL = 'https://szrybhleozpzfwhaoiha.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6cnliaGxlb3pwemZ3aGFvaWhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NzY2NDQsImV4cCI6MjA4NDI1MjY0NH0.d5xOftdoDnwiRLY8L81RDyj1dRc-LO3RE9n57KilwNU';
        const CLOUDINARY_CLOUD_NAME = 'dy77idija';
        const CLOUDINARY_UPLOAD_PRESET = 'photo-share-app';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let selectedFiles = [];
        let totalSize = 0;
        const MAX_FILES = 20;
        const MAX_TOTAL_SIZE = 35 * 1024 * 1024; // 35MB
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

        // 检查登录状态
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'auth.html';
            }
        }

        // 页面加载时检查登录状态
        checkAuth();

        // 处理拖拽
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.target.style.borderColor = '#6d28d9';
            e.target.style.background = 'rgba(109, 40, 217, 0.1)';
        }

        // 处理文件放置
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.style.borderColor = '';
            uploadArea.style.background = '';
            
            const files = e.dataTransfer.files;
            handleFiles(files);
        }

        // 处理文件选择
        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        // 处理文件
        function handleFiles(files) {
            const newFiles = Array.from(files);
            
            // 检查文件数量限制
            if (selectedFiles.length + newFiles.length > MAX_FILES) {
                showMessage(`最多只能选择 ${MAX_FILES} 张照片`, 'error');
                return;
            }
            
            // 检查文件大小
            for (const file of newFiles) {
                if (file.size > MAX_FILE_SIZE) {
                    showMessage(`文件 "${file.name}" 超过10MB限制`, 'error');
                    return;
                }
                
                if (totalSize + file.size > MAX_TOTAL_SIZE) {
                    showMessage(`总大小超过35MB限制`, 'error');
                    return;
                }
                
                if (!file.type.match('image.*')) {
                    showMessage(`文件 "${file.name}" 不是图片格式`, 'error');
                    return;
                }
            }
            
            // 添加文件
            selectedFiles.push(...newFiles);
            totalSize += newFiles.reduce((sum, file) => sum + file.size, 0);
            
            updatePreview();
            updateFileInfo();
        }

        // 更新预览
        function updatePreview() {
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="预览">
                        <button class="remove-image" onclick="removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="file-info">
                            <small>${formatFileSize(file.size)}</small>
                        </div>
                    `;
                    previewContainer.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
        }

        // 更新文件信息
        function updateFileInfo() {
            const uploadBtn = document.getElementById('uploadBtn');
            if (selectedFiles.length === 0) {
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> 请先选择照片';
            } else {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = `<i class="fas fa-upload"></i> 上传 ${selectedFiles.length} 张照片`;
            }
        }

        // 移除文件
        function removeFile(index) {
            totalSize -= selectedFiles[index].size;
            selectedFiles.splice(index, 1);
            updatePreview();
            updateFileInfo();
        }

        // 清空所有
        function clearAll() {
            selectedFiles = [];
            totalSize = 0;
            updatePreview();
            updateFileInfo();
            hideMessages();
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 显示消息
        function showMessage(message, type) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            if (type === 'error') {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
            } else {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                errorDiv.style.display = 'none';
            }
            
            // 3秒后自动隐藏
            setTimeout(() => {
                if (type === 'error') {
                    errorDiv.style.display = 'none';
                } else {
                    successDiv.style.display = 'none';
                }
            }, 5000);
        }

        // 隐藏消息
        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // 上传到Cloudinary
        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            formData.append('cloud_name', CLOUDINARY_CLOUD_NAME);
            
            try {
                const response = await fetch(
                    `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
                    {
                        method: 'POST',
                        body: formData
                    }
                );
                
                const data = await response.json();
                return data.secure_url;
            } catch (error) {
                console.error('上传失败:', error);
                throw new Error('图片上传失败');
            }
        }

        // 上传照片
        async function uploadPhotos() {
            if (selectedFiles.length === 0) {
                showMessage('请先选择照片', 'error');
                return;
            }
            
            const keywordsInput = document.getElementById('keywords').value.trim();
            if (!keywordsInput) {
                showMessage('请至少输入一个关键词', 'error');
                return;
            }
            
            // 解析关键词
            const keywords = keywordsInput.split(',')
                .map(k => k.trim())
                .filter(k => k.length > 0)
                .slice(0, 10); // 最多10个关键词
            
            if (keywords.length === 0) {
                showMessage('请至少输入一个关键词', 'error');
                return;
            }
            
            const description = document.getElementById('description').value.trim();
            const isPrivate = document.getElementById('isPrivate').checked;
            
            // 获取当前用户
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                showMessage('请先登录', 'error');
                return;
            }
            
            const user = session.user;
            const username = user.user_metadata?.name || user.email.split('@')[0];
            const userAvatar = user.user_metadata?.avatar_url;
            
            // 显示进度条
            const progressDiv = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            progressDiv.style.display = 'block';
            
            // 禁用上传按钮
            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 上传中...';
            
            let uploadedCount = 0;
            const errors = [];
            
            // 上传每张照片
            for (let i = 0; i < selectedFiles.length; i++) {
                try {
                    // 更新进度
                    const progress = Math.round((i / selectedFiles.length) * 100);
                    progressFill.style.width = progress + '%';
                    progressText.textContent = `正在上传第 ${i + 1} 张，共 ${selectedFiles.length} 张`;
                    
                    // 上传到Cloudinary
                    const imageUrl = await uploadToCloudinary(selectedFiles[i]);
                    
                    // 保存到数据库
                    const { error } = await supabase
                        .from('photos')
                        .insert({
                            user_id: user.id,
                            username: username,
                            user_avatar: userAvatar,
                            image_url: imageUrl,
                            description: description,
                            keywords: keywords,
                            is_private: isPrivate
                        });
                    
                    if (error) {
                        errors.push(`第 ${i + 1} 张照片保存失败: ${error.message}`);
                    } else {
                        uploadedCount++;
                    }
                    
                } catch (error) {
                    errors.push(`第 ${i + 1} 张照片上传失败: ${error.message}`);
                }
            }
            
            // 完成上传
            progressFill.style.width = '100%';
            progressText.textContent = '上传完成！';
            
            if (errors.length === 0) {
                showMessage(`成功上传 ${uploadedCount} 张照片`, 'success');
                
                // 清空表单
                setTimeout(() => {
                    clearAll();
                    document.getElementById('description').value = '';
                    document.getElementById('keywords').value = '';
                    document.getElementById('isPrivate').checked = false;
                    progressDiv.style.display = 'none';
                    
                    // 重置上传按钮
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-upload"></i> 上传照片';
                    
                    // 3秒后跳转
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                }, 2000);
                
            } else {
                showMessage(`上传完成，但有 ${errors.length} 个错误: ${errors.join('; ')}`, 'error');
                
                // 重置上传按钮
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> 重新上传';
            }
        }

        // 初始化
        updateFileInfo();

        // 切换移动端菜单
        function toggleMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('active');
        }
    </script>
</body>
</html>