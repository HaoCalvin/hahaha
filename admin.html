<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜é¢æ¿ - å…‰å½±åˆ†äº«</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <i class="fas fa-camera"></i>
                <span>å…‰å½±åˆ†äº« - ç®¡ç†é¢æ¿</span>
            </a>
            
            <div class="nav-links">
                <a href="index.html"><i class="fas fa-home"></i> è¿”å›é¦–é¡µ</a>
                <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> é€€å‡º</a>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="admin-panel">
            <h1><i class="fas fa-user-shield"></i> ç®¡ç†å‘˜æ§åˆ¶é¢æ¿</h1>
            <p id="adminStatus">éªŒè¯ç®¡ç†å‘˜èº«ä»½...</p>
            
            <div class="admin-sections">
                <!-- ç…§ç‰‡ç®¡ç† -->
                <section class="admin-section">
                    <h2><i class="fas fa-images"></i> ç…§ç‰‡ç®¡ç†</h2>
                    <div class="search-bar">
                        <input type="text" id="searchPhotos" placeholder="æœç´¢ç…§ç‰‡æˆ–ç”¨æˆ·..." 
                               onkeyup="searchAdminPhotos(this.value)">
                        <select id="photoFilter" onchange="filterPhotos()">
                            <option value="all">æ‰€æœ‰ç…§ç‰‡</option>
                            <option value="reported">è¢«ä¸¾æŠ¥çš„</option>
                            <option value="private">ç§å¯†ç…§ç‰‡</option>
                            <option value="recent">æœ€è¿‘ä¸Šä¼ </option>
                        </select>
                    </div>
                    <div class="photos-list" id="adminPhotosList">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <p>åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </section>
                
                <!-- ç”¨æˆ·ç®¡ç† -->
                <section class="admin-section">
                    <h2><i class="fas fa-users"></i> ç”¨æˆ·ç®¡ç†</h2>
                    <div class="search-bar">
                        <input type="text" id="searchUsers" placeholder="æœç´¢ç”¨æˆ·..." 
                               onkeyup="searchAdminUsers(this.value)">
                    </div>
                    <div class="users-list" id="adminUsersList">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <p>åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </section>
                
                <!-- ç»Ÿè®¡æ•°æ® -->
                <section class="admin-section">
                    <h2><i class="fas fa-chart-bar"></i> ç»Ÿè®¡æ•°æ®</h2>
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <i class="fas fa-images"></i>
                            <h3>æ€»ç…§ç‰‡æ•°</h3>
                            <p id="totalPhotos">0</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-users"></i>
                            <h3>æ€»ç”¨æˆ·æ•°</h3>
                            <p id="totalUsers">0</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-heart"></i>
                            <h3>æ€»ç‚¹èµæ•°</h3>
                            <p id="totalLikes">0</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-comment"></i>
                            <h3>æ€»è¯„è®ºæ•°</h3>
                            <p id="totalComments">0</p>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script>
        // é…ç½®ä¿¡æ¯
        const SUPABASE_URL = 'https://szrybhleozpzfwhaoiha.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6cnliaGxlb3pwemZ3aGFvaWhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NzY2NDQsImV4cCI6MjA4NDI1MjY0NH0.d5xOftdoDnwiRLY8L81RDyj1dRc-LO3RE9n57KilwNU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const ADMIN_ID = 'HAOCHEN'; // ç®¡ç†å‘˜ID
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAdminAccess();
            loadAdminData();
        });
        
        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        async function checkAdminAccess() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                window.location.href = 'auth.html';
                return;
            }
            
            const user = session.user;
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
            if (user.id !== ADMIN_ID) {
                document.getElementById('adminStatus').innerHTML = 
                    '<span style="color: #ef4444;">æ‚¨ä¸æ˜¯ç®¡ç†å‘˜ï¼Œæ— æƒè®¿é—®æ­¤é¡µé¢</span>';
                document.querySelector('.admin-sections').style.display = 'none';
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
                return;
            }
            
            document.getElementById('adminStatus').innerHTML = 
                `<span style="color: #10b981;">ç®¡ç†å‘˜å·²ç™»å½•ï¼š${user.email}</span>`;
        }
        
        // åŠ è½½ç®¡ç†æ•°æ®
        async function loadAdminData() {
            loadAdminPhotos();
            loadAdminUsers();
            loadStats();
        }
        
        // åŠ è½½ç®¡ç†å‘˜ç…§ç‰‡
        async function loadAdminPhotos(filter = 'all') {
            let query = supabase
                .from('photos')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);
            
            if (filter === 'private') {
                query = query.eq('is_private', true);
            } else if (filter === 'recent') {
                query = query.gte('created_at', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString());
            }
            
            const { data: photos, error } = await query;
            
            if (error) {
                console.error('åŠ è½½ç…§ç‰‡å¤±è´¥:', error);
                return;
            }
            
            displayAdminPhotos(photos);
        }
        
        // æ˜¾ç¤ºç®¡ç†å‘˜ç…§ç‰‡
        function displayAdminPhotos(photos) {
            const container = document.getElementById('adminPhotosList');
            
            if (!photos || photos.length === 0) {
                container.innerHTML = '<p>æ²¡æœ‰ç…§ç‰‡</p>';
                return;
            }
            
            container.innerHTML = '';
            
            photos.forEach(photo => {
                const photoItem = document.createElement('div');
                photoItem.className = 'admin-photo-item';
                photoItem.innerHTML = `
                    <div class="admin-photo-info">
                        <img src="${photo.image_url}" alt="é¢„è§ˆ" class="admin-photo-thumb">
                        <div class="admin-photo-details">
                            <p><strong>ç”¨æˆ·ï¼š</strong>${photo.username}</p>
                            <p><strong>æè¿°ï¼š</strong>${photo.description || 'æ— '}</p>
                            <p><strong>å…³é”®è¯ï¼š</strong>${photo.keywords?.join(', ') || 'æ— '}</p>
                            <p><strong>æ—¶é—´ï¼š</strong>${new Date(photo.created_at).toLocaleString('zh-CN')}</p>
                            <p><strong>çŠ¶æ€ï¼š</strong>${photo.is_private ? 'ç§å¯†' : 'å…¬å¼€'}</p>
                            <p><strong>æ•°æ®ï¼š</strong>â¤ï¸${photo.likes_count} ğŸ’¬${photo.comments_count} ğŸ‘ï¸${photo.view_count}</p>
                        </div>
                    </div>
                    <div class="admin-photo-actions">
                        <button class="btn-danger" onclick="deletePhotoAsAdmin('${photo.id}')">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                        <button class="btn-warning" onclick="togglePhotoPrivacy('${photo.id}', ${photo.is_private})">
                            ${photo.is_private ? '<i class="fas fa-eye"></i> è®¾ä¸ºå…¬å¼€' : '<i class="fas fa-eye-slash"></i> è®¾ä¸ºç§å¯†'}
                        </button>
                    </div>
                `;
                container.appendChild(photoItem);
            });
        }
        
        // æœç´¢ç®¡ç†å‘˜ç…§ç‰‡
        async function searchAdminPhotos(query) {
            if (!query) {
                loadAdminPhotos();
                return;
            }
            
            const { data: photos, error } = await supabase
                .from('photos')
                .select('*')
                .or(`description.ilike.%${query}%,username.ilike.%${query}%`)
                .order('created_at', { ascending: false })
                .limit(50);
            
            if (!error && photos) {
                displayAdminPhotos(photos);
            }
        }
        
        // ç­›é€‰ç…§ç‰‡
        function filterPhotos() {
            const filter = document.getElementById('photoFilter').value;
            loadAdminPhotos(filter);
        }
        
        // åŠ è½½ç®¡ç†å‘˜ç”¨æˆ·
        async function loadAdminUsers() {
            // ä»ç…§ç‰‡è¡¨ä¸­è·å–ç”¨æˆ·ä¿¡æ¯
            const { data: photos, error } = await supabase
                .from('photos')
                .select('user_id, username, user_avatar')
                .order('created_at', { ascending: false })
                .limit(100);
            
            if (error) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
                return;
            }
            
            // å»é‡
            const uniqueUsers = [];
            const seen = new Set();
            
            photos?.forEach(photo => {
                if (!seen.has(photo.user_id)) {
                    seen.add(photo.user_id);
                    uniqueUsers.push({
                        id: photo.user_id,
                        username: photo.username,
                        avatar: photo.user_avatar
                    });
                }
            });
            
            displayAdminUsers(uniqueUsers);
        }
        
        // æ˜¾ç¤ºç®¡ç†å‘˜ç”¨æˆ·
        function displayAdminUsers(users) {
            const container = document.getElementById('adminUsersList');
            
            if (!users || users.length === 0) {
                container.innerHTML = '<p>æ²¡æœ‰ç”¨æˆ·</p>';
                return;
            }
            
            container.innerHTML = '';
            
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'admin-user-item';
                userItem.innerHTML = `
                    <div class="admin-user-info">
                        <img src="${user.avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.username) + '&background=random'}" 
                             class="avatar-sm" alt="${user.username}">
                        <div>
                            <p><strong>${user.username}</strong></p>
                            <small>ID: ${user.id.substring(0, 8)}...</small>
                        </div>
                    </div>
                    <div class="admin-user-actions">
                        <button class="btn-danger" onclick="deleteUserPhotos('${user.id}')">
                            <i class="fas fa-trash"></i> åˆ é™¤æ‰€æœ‰ç…§ç‰‡
                        </button>
                        <button class="btn-secondary" onclick="viewUserProfile('${user.id}')">
                            <i class="fas fa-eye"></i> æŸ¥çœ‹ä¸»é¡µ
                        </button>
                    </div>
                `;
                container.appendChild(userItem);
            });
        }
        
        // æœç´¢ç®¡ç†å‘˜ç”¨æˆ·
        async function searchAdminUsers(query) {
            if (!query) {
                loadAdminUsers();
                return;
            }
            
            const { data: photos, error } = await supabase
                .from('photos')
                .select('user_id, username, user_avatar')
                .ilike('username', `%${query}%`)
                .limit(50);
            
            if (error) {
                console.error('æœç´¢ç”¨æˆ·å¤±è´¥:', error);
                return;
            }
            
            // å»é‡
            const uniqueUsers = [];
            const seen = new Set();
            
            photos?.forEach(photo => {
                if (!seen.has(photo.user_id)) {
                    seen.add(photo.user_id);
                    uniqueUsers.push({
                        id: photo.user_id,
                        username: photo.username,
                        avatar: photo.user_avatar
                    });
                }
            });
            
            displayAdminUsers(uniqueUsers);
        }
        
        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            // æ€»ç…§ç‰‡æ•°
            const { count: totalPhotos } = await supabase
                .from('photos')
                .select('*', { count: 'exact', head: true });
            
            // æ€»ç‚¹èµæ•°
            const { count: totalLikes } = await supabase
                .from('likes')
                .select('*', { count: 'exact', head: true });
            
            // æ€»è¯„è®ºæ•°
            const { count: totalComments } = await supabase
                .from('comments')
                .select('*', { count: 'exact', head: true });
            
            // æ€»è®¨è®ºæ•°
            const { count: totalDiscussions } = await supabase
                .from('discussions')
                .select('*', { count: 'exact', head: true });
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('totalPhotos').textContent = totalPhotos || 0;
            document.getElementById('totalLikes').textContent = totalLikes || 0;
            document.getElementById('totalComments').textContent = totalComments || 0;
            
            // ç”¨æˆ·æ•°éœ€è¦ä»auth.usersè·å–ï¼Œä½†éœ€è¦æƒé™
            // è¿™é‡Œä½¿ç”¨ç…§ç‰‡è¡¨ä¸­çš„å”¯ä¸€ç”¨æˆ·æ•°ä½œä¸ºè¿‘ä¼¼å€¼
            const { data: photos } = await supabase
                .from('photos')
                .select('user_id')
                .limit(1000);
            
            if (photos) {
                const uniqueUserIds = new Set(photos.map(p => p.user_id));
                document.getElementById('totalUsers').textContent = uniqueUserIds.size;
            }
        }
        
        // ç®¡ç†å‘˜åˆ é™¤ç…§ç‰‡
        async function deletePhotoAsAdmin(photoId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }
            
            const { error } = await supabase
                .from('photos')
                .delete()
                .eq('id', photoId);
            
            if (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            } else {
                alert('åˆ é™¤æˆåŠŸï¼');
                loadAdminPhotos();
                loadStats();
            }
        }
        
        // åˆ‡æ¢ç…§ç‰‡éšç§çŠ¶æ€
        async function togglePhotoPrivacy(photoId, isPrivate) {
            const { error } = await supabase
                .from('photos')
                .update({ is_private: !isPrivate })
                .eq('id', photoId);
            
            if (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            } else {
                alert('æ“ä½œæˆåŠŸï¼');
                loadAdminPhotos();
            }
        }
        
        // åˆ é™¤ç”¨æˆ·æ‰€æœ‰ç…§ç‰‡
        async function deleteUserPhotos(userId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç”¨æˆ·çš„æ‰€æœ‰ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }
            
            const { error } = await supabase
                .from('photos')
                .delete()
                .eq('user_id', userId);
            
            if (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            } else {
                alert('åˆ é™¤æˆåŠŸï¼');
                loadAdminPhotos();
                loadStats();
            }
        }
        
        // æŸ¥çœ‹ç”¨æˆ·ä¸»é¡µ
        function viewUserProfile(userId) {
            window.open(`profile.html?user=${userId}`, '_blank');
        }
        
        // é€€å‡ºç™»å½•
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>